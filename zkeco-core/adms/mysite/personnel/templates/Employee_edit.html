<object classid="clsid:A318A9AC-E75F-424C-9364-6B40A848FC6B" width=0 height=0 id=zkonline >
   </object>
   <COMMENT style="display:None">
       <embed type="application/x-eskerplus"
           classid="clsid:A318A9AC-E75F-424C-9364-6B40A848FC6B"        
           codebase="ZKOnline.ocx"                          
       </EMBED>
   </COMMENT>

{% extends "data_edit.html" %}
{% load i18n %}

{% block form %}
    {% if request.user|HasPerm:"personnel.add_employee" or request.user|HasPerm:"personnel.change_employee" %}
    {% autoescape off %} 
    <tr>
        <td>
            <div class="displayN">
                <table>
                    <tr>
                        {{form.lng}}
                    </tr>
                    <tr>
                        {{form.tcount}}
                    </tr>
                    <tr>
                        {{form.tfids}}
                    </tr>
                    <tr>
                        {{form.fpcode}}
                    </tr>
                    <tr>
                        {{form.tcount10}}
                    </tr>
                    <tr>
                        {{form.tfids10}}
                    </tr>
                    <tr>
                     {{form.pin_width}}
                    </tr>
                </table>
            </div>
            <div id="id_emp_info" class="div_box1 floatL">
                <h2>{% trans '人员基础资料' %}</h2>
                <table id="ic_emp_info_tbl" border="0" cellspacing="0" cellpadding="0" class="displayB">
                    <tr>
                        <th height="20">{{ form.PIN|field_as_label_tag }}</th>
                        <td>{{form.PIN.as_widget }}</td>
                        <td width="130">
                            <div  class="floatL lineH22" >
                                <a id ="id_checkNo" class="Link_blue1" href="javascript:void(0)" onclick="javascript:check_PIN(this)">{%trans '验证'%}</a>
                            </div>
                            <div id='div_id_pin'  class="floatL color_orange lineH22"></div>
                        </td>

                        <th>{{ form.contry|field_as_label_tag }}</th>
                        <td width="180">{{form.contry.as_widget}}</td>
                        <td width="80">{{form.contry.errors }}</td>
                        <td rowspan="7" >
                            <div class="div_img floatL">
                            <div class="displayN">{{form.chkph}}</div>
                            <div class="displayN">{{form.install_language}}</div>
                            <div class="ar_r_t"><div class="ar_l_t"><div class="ar_r_b"><div class="ar_l_b"><img id='id_img_personnel' width="120px" height="140px" src="{% if instance.photo %}/{{request.surl}}file/{{ instance.photo.url }}{% else %}error.jpg{% endif %}" onerror="this.src='{{ MEDIA_URL }}/images/userImage.gif'"  alt="personnel photo"/></div></div></div></div></div>
                            <div class="clear"></div>
                            <div>
                                <div style="position:absolute;">
                                    {% trans '上传个人照片'%}<br /><span class="color_orange" style="padding-right:10px;">{% trans '(最佳尺寸为120×140像素)'%}</span>
                                    <br />{{form.photo.as_widget }}
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th height="20">{{ form.EName|field_as_label_tag }}</th>
                        <td>{{form.EName.as_widget }}</td>
                        <td>{{form.EName.errors }}</td>

                        {{ form.City|field_as_td_h }}
                    </tr>
                    <tr>
                        <th height="20">{{ form.lastname|field_as_label_tag }}</th>
                        <td>{{form.lastname.as_widget }}</td>
                        <td>{{form.lastname.errors }}</td>

                        {{ form.PostCode|field_as_td_h }}
                    </tr>
                    <tr>
                        <th height="20">{{ form.Gender|field_as_label_tag }}</th>
                        <td>{{form.Gender.as_widget }}</td>
                        <td>{{form.Gender.errors }}</td>

                        {{ form.Tele|field_as_td_h }}
                    </tr>
                    <tr>
                        <th height="20">{{ form.Card|field_as_label_tag }}</th>
                        <td>{{form.Card.as_widget }}</td>
                        <td><a href="javascript:void(0)" style="display:None">{%trans '连接发卡器'%}</a></td>
                        
                        {{ form.FPHONE|field_as_td_h }}
                    </tr>
                    <tr>
                        <th height="20">{{ form.Password|field_as_label_tag }}</th>
                        <td>{{form.Password.as_widget }}<br/>{{form.Password.help_text }}</td>
                        <td>{{form.Password.errors }}</td>
                        
                        {{ form.Mobile|field_as_td_h }}
                    </tr>
                     <tr>
                        <th height="20">{{ form.DeptID|field_as_label_tag }}</th>
                        <td>{{form.DeptID.as_widget }}</td>
                        <td>{{form.DeptID.errors }}</td>
                        
                        {{ form.National|field_as_td_h }}
                     </tr>
                    
                    <tr>
                        <th height="20">{{ form.identitycard|field_as_label_tag }}</th>
                        <td>{{form.identitycard.as_widget}}</td>
                        <td>
                            <div class="floatL lineH22">
                                <a id="id_personnelsn" class="Link_blue1" href="javascript:void(0)" onclick="javascript:check_identity(this)">{%trans '验证'%}</a>
                            </div>
                            <div id='div_id_identitycard'  class="floatL color_orange lineH22"></div>
                        </td>
                        {{ form.Birthday|field_as_td_h }}
                        
                    </tr>
                    <tr id="en_displayN">
                        <th height="20">{{ form.Education|field_as_label_tag }}</th>
                        <td colspan="2">{{form.Education.as_widget}}{{form.Education.errors }}</td>
                        {{ form.Title|field_as_td_h }}
                        
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <th>{{ form.Hiredday|field_as_label_tag }}</th>
                        <td colspan="2"  >{{form.Hiredday.as_widget }}{{form.Hiredday.errors }}</td>
                        
                        {{ form.email|field_as_td_h }}  
                        <td></td>
                        <td style="text-align: left;width:180px;">
                        <!-- {{form.photo.as_widget }}-->
                        <!-- <input type="file" id="id_upload_file" name="fileUpload" size="15"/>-->
                        </td>
                    </tr>
                    <tr>
                        <th height="20">{{ form.hiretype|field_as_label_tag }}</th>
                        <td>{{form.hiretype.as_widget }}</td>
                        <td>{{form.hiretype.errors }}</td>

                        {{ form.birthplace|field_as_td_h }}
                    </tr>
                    <tr>
                        <th height="20">{{ form.emptype|field_as_label_tag }}</th>
                        <td>{{form.emptype.as_widget }}</td>
                        <td>{{form.emptype.errors }}</td>

                        <th>{{ form.Address|field_as_label_tag }}</th>
                        <td colspan="3">{{form.Address.as_widget}}</td>
                        <!--<td  >{{form.Address.errors }}</td>-->
                    </tr>
                    <tr>
                        <th height="20">{{ form.Political|field_as_label_tag }}</th>
                        <td>{{form.Political.as_widget }}</td>
                        <td>{{form.Political.errors }}</td>

                        <th>{{ form.homeaddress|field_as_label_tag }}</th>
                        <td colspan="3">{{form.homeaddress.as_widget}}</td>
                  
                        <!--<td  >{{form.homeaddress.errors }}</td>-->
                    </tr>
                    {% if "mysite.att" or "mysite.iaccess"|hasApp %}
                    <tr>
                        <th height="20">{% trans '登记指纹'%}:</th>
                            <td colspan="2"><div class="floatL Link_blue1" style="width:150px;"><a href="javascript:void(0)" onclick="submitRegister()">{% trans '指纹登记'%}</a></div>
                                <div id="div_id_finngerT" class="floatL"></div>
                                <input type="hidden" id="id_finnger" name="finnger" alt="" value=""> </input>
                                <input type="hidden" id="id_template"  value="" name="template" alt=""> </input>
                                <input type="hidden" id="id_finnger10" name="finnger10" alt="" value=""> </input>
                                <input type="hidden" id="id_template10"  value="" name="template10" alt="">  </input>
                                <input type="hidden" id="id_delfinger"  value="" name="delfinger" alt=""> </input>
                                <input type="hidden" id="id_fptype"  value="" name="fptype" alt=""> </input>
                                <input type="hidden" id="id_durfinger"  value="" name="durfinger" alt=""> </input>
                                <input type="hidden" id="id_durfpid"  value="" name="durfpid" alt=""> </input>
                                <input type="hidden" id="id_delflag"  value="" name="delflag" alt="delete"> </input>
                            </td>
                    </tr>
                    {% endif %}
                    {% if "mysite.att" or "mysite.iaccess"|hasApp %}                
                    <tr style="display:None">
                        <td height="20">&nbsp;</td>
                        <td colspan="2"  ><a href="javascript:void(0)" onclick="submitRemoteIdentification()">{% trans '指纹机登记'%}</a>          <div id="div_id_finngerM"></div></td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </td>
    </tr>

    {% if "mysite.att"|hasApp %}
    <tr>
        <td>
            <div id="id_Att_info" class="div_box1 floatL">
                <h2>{% trans '考勤设置' %}</h2>
                    <table id="id_Att_info_tbl" border="0" cellspacing="0" cellpadding="0">
                        <tr>
                          <th rowspan="5" width="65" style="vertical-align:top">{{ form.attarea|field_as_label_tag }}</th>
                          <td rowspan="5">{{form.attarea.as_widget }}</td>
                          <td   height="20" width="55">&nbsp;</td>

                          <td width="55" rowspan="7" valign="top">
                              <table border="0" cellpadding="3" cellspacing="0">
                                <tr style="display:none;">
                                  <th height="20">{{ form.INLATE|field_as_label_tag }}</th>
                                  <td>{{form.INLATE.as_widget }}</td>
                                  <td>{{form.INLATE.errors }}</td>
                                </tr>
                                <tr style="display:none;">
                                  <th height="20">{{ form.OutEarly|field_as_label_tag }}</th>
                                  <td>{{form.OutEarly.as_widget }}</td>
                                  <td>{{form.OutEarly.errors }}</td>
                                </tr>
                                <tr>
                                    {{ form.isatt|field_as_td_h }}
                                </tr>
                                <tr>
                                    {{ form.Privilege|field_as_td_h }}
                                </tr>

                                
                                <tr style="display:none;">
                                    {{ form.AutoSchPlan|field_as_td_h }}
                                </tr>
                              </table></td>
                          </tr>
                        <tr>
                          <td height="20">{{form.attarea.errors }}</td>
                        </tr>
                    </table>
            </div>
        </td>
    </tr>
    {% endif %}
    {% if "mysite.iaccess"|hasApp %}
    <tr>
        <td>
            <div id="id_access_info" class="div_box1 floatL">
                <h2>{% trans '门禁设置' %}</h2>
                    <table id="id_access_info_tbl" border="0" cellspacing="0" cellpadding="0">
                        <!--权限组添加-->
                        <tr>
                            <th>{% trans "门禁权限组:" %}</th>
                            <td>
                                <div id="id_level" style="border:1px solid #71A8D8"></div></div>
                            </td>
                        </tr>
                        
                        <tr id="set_valid_time">
                            {{ form.set_valid_time|field_as_td_h }}{{ form.acc_startdate|field_as_td_h }}{{ form.acc_enddate|field_as_td_h }}
                        </tr>

                        <tr>
                            {{ form.morecard_group|field_as_td_h }}
                        </tr>
                        <tr class="displayN"><th></th><td><input type="checkbox" name="level_changed" class="wZBaseBooleanField" id="id_level_changed"></td></tr>
                    </table>
            </div>
        </td>
    </tr>
    {% endif %}
    {% if form.non_field_errors %}
        <tr><td>{{ form.non_field_errors }}</td></tr>
    {% endif %}

    {% endautoescape %}
    {% endif %}<!--add/change_employee-->
    
{% endblock %}

{% block addjs%}
    //获取安装语言
   // alert($("#id_install_language").val());
    if($("#id_install_language").val() == "en"){
        $("#en_displayN").remove();
    }
    //身份证验证
    function check_identity(obj){
        var value=$("#id_identitycard").val();
        var blnchina=true;
        var divedit=$("#id_edit_form");
        var div=$("#div_id_identitycard")
        div.html("");
        if(divedit.find("#id_lng").val()=='zh-cn')
        {
            if(value.length==15 || value.length==18){
                //divedit.find("#id_personnelsn").click();
                autofill($("#div_id_identitycard").parent().parent().parent(),value.toString());
            }else{
                //alert(gettext('身份证号码不正确'));
               
                div.html("&times;"+gettext("不合法"));
                return;
            }
        }	
        
        wgCheckNo('identitycard','div_id_identitycard',obj,'{{dbapp_url}}','personnel','Employee');
    }
    //人员编号验证
    function check_PIN(obj)
    {
       
        var div=$("#div_id_pin");
        var v=$("#id_PIN").val();
        var v_int=parseInt(v) 
        div.html("");
        if (v_int==0||!CheckNumber(v))
        {
            div.html("&times;"+gettext("不合法"));
            return;
        }
       
        wgCheckNo('PIN','div_id_pin',obj,'{{dbapp_url}}','personnel','Employee'); 
    }
  
    
    {% if request.user|HasPerm:"personnel.add_employee" or request.user|HasPerm:"personnel.change_employee" %}
    var old_levels=new Array();
    var new_levels=new Array();
    
	if($("#id_common_opt").length > 0)//从我的工作面板新增人员
	{
		 $("#id_level_changed").attr("checked",true);
	}
    function before_submit()
    {
        $("#levelSingleBrowser input").each(function(){
            if($(this).attr("checked")==true)
            {
                new_levels.push($(this).attr("value"));
            }
        });
        if(new_levels.sort().toString()!=old_levels.sort().toString())
        {
            $("#id_level_changed").attr("checked",true);
        }
        return true;
    }
    
    function set_valid_time_show()
    {
        $("#set_valid_time").find("th:gt(0)").show();
        $("#set_valid_time").find("td:gt(0)").show(); 
    }

    function set_valid_time_hide()
    {
        $("#set_valid_time").find("th:gt(0)").hide();
        $("#set_valid_time").find("td:gt(0)").hide();
    }

    //保存并继续
    function after_save_continue()
    {
        set_valid_time_hide();
    }

    $(".tbl_data_edit").css({width:"96%"});
    //收缩功能	
    function slide(tbl,h2){	
        if (!$(tbl).is(":visible")) 
        {
            $(tbl).show();
            $(h2).removeClass("div_box1_slide");
        }
        else
        {
            $(tbl).hide();
            $(h2).addClass("div_box1_slide");
        }
    };
        
    var idata=[]

    $(function(){
        var divedit=$("#id_edit_form")
        divedit.find("#id_photo").change(function(){
            if($(this).val()!=""){   
                if( !this.value.match( /.jpg|.gif|.png|.bmp/i ) ){
                    alert(gettext('图片格式无效!'));
                    return false;
                }
                if(!$.browser.msie){
                    divedit.find("#id_img_personnel").attr("src",this.files[0].getAsDataURL());
                }else{
                    this.select();
                    divedit.find("#id_img_personnel").attr("src",document.selection.createRange().text);
                }
            }
        });
        if($("input[name='pk']").val()!="None" )
        {
            $("input[name='PIN']").attr("readonly","readonly");
            //if($("input[name='chkph']").attr("checked")){
            //divedit.find("#id_img_personnel").attr("src",'{% if instance.photo %}/{{request.surl}}file/{{ instance.photo.url }}{% endif %} ');
            //}
        }
        divedit.find("#id_PIN").attr("maxlength",divedit.find("#id_pin_width").val());
        divedit.find("#id_PIN").change(function(){
            if(!CheckNumber($(this).val()))
            {
                alert(gettext('人员编号必须为数字'));
                return;
            }
            
            divedit.find("#id_checkNo").click();
        });
        divedit.find("#id_email").blur(function()
        {
            var str=$("#id_email").val();
            str = str.replace(/[ ]/g,""); 
            if(str!="")
            {
                var myreg = /^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;
                if(!myreg.test(str))
                {
                    alert(gettext('请输入有效的E_mail!'));
                    return ;
                }
                divedit.find("#id_checkNo").click();
            }
        });
        
        $.ajax({
            url:"{{dbapp_url}}../personnel/getmodeldata/base/BaseCode/?fields=content,value,display&content__exact=IDENTITY",
            dataType:"json",
            type:"POST",
            success:function(data){
                idata=data;
            }
        });
        
        var div=$("#div_id_identitycard").parent().parent().parent();
        if(divedit.find("#id_lng").val()!='zh-cn')
        {
            divedit.find("#id_personnelsn").addClass("displayN");
        }
        div.find("#id_identitycard").change(function(){
            var value=$(this).val()
            blnchina=true;
            if(divedit.find("#id_lng").val()=='zh-cn')
            {
                if(value.length==15 || value.length==18)            
                {	
                    divedit.find("#id_personnelsn").click();
                    autofill(div,value.toString());
                }
                else
                {
                    alert(gettext('身份证号码不正确'));
                    return;
                }
            }	
        });
        if(divedit.find("#id_PIN").val()!="")
        {
            $("#div_id_finngerT").html("{% trans '已登记指纹 ' %}"+ divedit.find("#id_tcount").val() );
        }

    });
    function autofill(div,id)
    {	var address=""
        if (idata.length==0)
            return;
        //省
        if(idata.length>=2)
        {
            address=getvalue(id.substr(0,2));
        }
        //市
        if(idata.length>=2)
        {
            address+=getvalue(id.substr(0,4));
        }
        //县
        if(idata.length>=2)
        {
            address+=getvalue(id.substr(0,6));
        }
        
        div.find("#id_homeaddress").attr("value",address);
        if (id.length>=12)
        {
            var bd=""
            if(id.length>=12 && id.length<=15)
            {
                bd='19'+id.substr(6,2)+'-'+id.substr(8,2)+'-'+id.substr(10,2);
            }
            else
            {
                bd=id.substr(6,4)+'-'+id.substr(10,2)+'-'+id.substr(12,2);
            }
            div.find("#id_Birthday").attr("value",bd);
        }
    }
    function getvalue(arid)
    {
        var i=0
        for (i=0;i<idata.length;i++)
        {
            if (idata[i][1]==arid)
            {
                return idata[i][2];
            }
        }
        return ""
    }
    function resizeImage(targetImg,imgSrc,fitWidth,fitHeight)
    {
        /*
         兼容于ie,firefox,netscape的等比例图片本地预览的javascript实现
         author:semovy@gmail.com
         date:14:39 上午 2007-10-9
         @param:targetImg string id 待显示等比例调整过的目标元素的id字符串
         @param:imgSrc string src 等处理的图片源路径字符串
         @param:fitWidth int 等显示图片的最大宽度
         @param:fitHeight int 等显示图片的最大高度
        */
        var imgSrc = "file:///" + imgSrc.replace(/\\/g,"/");//本地路径c:\a.jpg,而ff,ns不支持,所以替换成file:///c:/a.jpg这种形式
        var img = document.getElementById(targetImg);//获取目标图片元素容器
        var tempImg = new Image();//建立临时图片对象
        tempImg.src = imgSrc;//给临时图片对象赋予图片源
        var scale=1.0;//图片度高比例因子.
        var width=0,height=0;
     
        /*firefox实现了complete属性，而ie实现了complete属性和readyState属性
        但是两者对属性的定义好像不同：
        firefox： 一个图像被下载完毕，complete属性就是true，没有下载完毕则为false
        ie：一个图像没有被下载完毕，则readyState属性为uninitialized,complete属性是false.当下载完毕时，
        readyState为complete，而如果此时图片还没有显示，complete为false,显示以后(display:block)此属性才变成true
        */
        if(document.all)//如果是ie
        {
            if(tempImg.readyState=='complete')
            {
                width = tempImg.width;//获取源图片宽,高
                height = tempImg.height;
            }
        }
        else(tempImg.complete)//fire fox ,netscape
        {
            width = tempImg.width;
            height = tempImg.height;
        }
        scale = width/height;//宽度比例因子
        if(width > fitWidth)//等比例调整
        {
            width = fitWidth;
            height = width/scale; 
            if(height > fitHeight)
            {
                height = fitHeight;
                width = height*scale;
            }
        }
        if(height > fitHeight)
        {
            height = fitHeight;
            width = height*scale;
        }
        img.width = width;//调整后的宽,高
        img.height = height;
        img.src = imgSrc;
        img.style.display="";//显示图片
    }

    function submitRegister()
    {
        var tmpadd=""
        var tfids=$("#id_tfids"+tmpadd).val();
        var fp=$("#id_finnger"+tmpadd).val();
        var fpcode = $("#id_fpcode").val();
        var durfp = $('#id_durfinger').val();    //获取指纹是普通指纹还是胁迫指纹的标记
        var fpcount = $("#id_tcount").val()     //从数据库传递过来的正常指纹数量
        //var durfpcount = $("#id_durtcount").val()    //从数据库传递过来的胁迫指纹数量
        var tmp=0
        var oldidscount = 0
        //var icount = 0;
        $("#id_delflag").val("delete");
        if(tfids!="")     //将普通指纹和胁迫指纹区分后组成一个字符串
        {
            durtfids = tfids.split(",");
            fpcode = fpcode.split(",");
            if(durfp=="")
            {
                durfp = "000000000";
            }
            for(var i=0; i<fpcode.length; i++)
            { 
                var durfp1 = "";
                var durfp2 = "";
                if(i==8)
                {
                    durfp1 = durfp.substr(0, durtfids[i]);
                }
                else
                {
                    durfp1 = durfp.substr(0, durtfids[i]);
                    durfp2 = durfp.substr(parseInt(durtfids[i])+1, durfp.length-1);
                }
                if( fpcode[i] == "3" )
                {
                    durfp = durfp1 + "3" + durfp2;     
                }
                else
                {
                    durfp = durfp1 + "1" + durfp2;     
                }
            }
        }
        if(tfids!="" || fp!="")
        {
            var te=tfids+","+fp;
                  
            if(te.substr(0,1)==",")
            {
              te=te.substr(1);
            }    
            if(te.substr(te.length-1,1)==",")
            {
              te=te.substr(0,te.length-1);
            }   

            tmp=te.split(",");
            oldidscount=tmp.length
            if(fp!="")     //同一登记指针，第二次以上打开登记窗口
            {
                var tt=fp.split(",")
                oldidscount=oldidscount-tt.length
            }

            var ids=""
            for(var i=0;i<10;i++)
            {
                var bln=false
                for(var j=0;j<tmp.length;j++)
                {
                    if(i==tmp[j])
                    {
                        bln=true;
                        break;
                    }
                }
                if(bln)
                {
                    if(durfp.substr(i,1)=="3")
                    {
                        ids+="3"
                    }
                    else
                    {
                        ids+="1"
                    }
                }
                else
                {
                    ids+="0"
                }
            }
            zkonline.CheckFinger=ids;
        }
        else
        {
            zkonline.CheckFinger="0000000000"
        }
        zkonline.IsSupportDuress = true     // 设置胁迫指纹有效
        if($("#id_lng").val()=='zh-cn')
        {
            zkonline.SetLanguageFile("zkonline.chs")  //设置为中文界面
        }
        if($("#id_lng").val()!='zh-cn')
        {
            zkonline.SetLanguageFile("zkonline.en")  //设置为英文界面
        }
        if (zkonline.Register()){
            var fingerids=[];
            var template=[];
            var fingertype=[];                
            var durfingerid = "";
            if($("#id_finnger"+tmpadd).val()!="")
            {
                var f=$("#id_finnger"+tmpadd).val().split(",");
                var t=$("#id_template"+tmpadd).val().split(",");
                var ft=$("#id_fptype").val().split(",");    //ft区分是普通指纹还是胁迫指纹
                for(var i=0;i<f.length;i++)
                {
                    fingerids.push(f[i]);
                    template.push(t[i]);
                    fingertype.push(ft[i])
                }
            }
            for(i=1;i<=10;i++)
            {
                if(zkonline.GetRegFingerTemplateEx('9',i).length>2)
                {
                    durfingerid = zkonline.CheckFinger;
                    fingerids.push(i-1);
                    fingertype.push(durfingerid.substr(i-1,1));
                    var t=zkonline.ConvertTemplateToEmStr( zkonline.GetRegFingerTemplateEx('9',i));
                    template.push(t);
                    $("#id_delflag").val("add");
                }
            }

            var count=0
            if(oldidscount>0)
            {
                count=fingerids.length+oldidscount
                var tid = tfids.split(",");
                for(var i=0;i<fingerids.length;i++)
                {
                    for(var j=0;j<tid.length;j++)
                    {
                        if(fingerids[i]==tid[j])
                        {
                            count-=1;                    
                        }
                    }
                }
            }
            else
            {
                count=fingerids.length
            }
            
            $("#id_durfinger").val(durfingerid.toString());
            $("#id_finnger"+tmpadd).val(fingerids.toString());
            $("#id_template"+tmpadd).val(template.toString());
            $("#id_fptype").val(fingertype.toString());
            
            $("#div_id_finngerT"+tmpadd).html("{% trans '已登记指纹 ' %}"+ count );

            tmpadd="10"
            var fingerids10=[];
            var template10=[];

            if($("#id_finnger"+tmpadd).val()!="")
            {
                var f=$("#id_finnger"+tmpadd).val().split(",");
                var t=$("#id_template"+tmpadd).val().split(",");
                for(var i=0;i<f.length;i++)
                {
                    fingerids10.push(f[i]);
                    template10.push(t[i]);
                }
            }

            for(i=1;i<=10;i++)
            {
                if(zkonline.GetRegFingerTemplateEx('10',i).length>2)
                {
                    fingerids10.push(i-1);
                    var t=zkonline.ConvertTemplateToEmStr( zkonline.GetRegFingerTemplateEx('10',i));
                    template10.push(t);
                }
            }
            var count=0
            if(oldidscount>0)
            {
                count=fingerids10.length+oldidscount
                var tid=tfids.split(",")
                for(var i=0;i<fingerids10.length;i++)
                {
                    for(var j=0;j<tid.length;j++)
                    {
                        if(fingerids10[i]==tid[j])
                        {
                            count-=1;                    
                        }
                    }
                }
            }
            else
            {
                count=fingerids10.length
            }
            $("#id_finnger"+tmpadd).val(fingerids10.toString());
            $("#id_template"+tmpadd).val(template10.toString());
            $("#id_fptype").val(fingertype.toString());
         }
         var flag = $("#id_delflag").val();
         if(tfids!="" && flag.localeCompare("delete")==0)             //删除指纹
         {
            tmp = tfids.split(",");   //数据库存有的指纹id
            var dbfpid = "";   //数据库存有指纹id颜色标记
            var delid = [];
            var index = 0;
            var fpidcount = tmp.length     //数据库中存有的指纹数    
            var compare_fp = $("#id_durfpid").val()  //从数据库中查询出来的指纹标记
            var fpid = zkonline.CheckFinger   //掉删除指纹后，检测当前指纹的id
            for(var i=0;i<10;i++)
            {
                var bln=false
                for(var j=0;j<fpidcount;j++)
                {
                    if(i==tmp[j])
                    {
                        bln=true;
                        break;
                    }
                }
                if(bln)
                {
                    if(durfp.substr(i,1)=="3")
                    {
                        dbfpid+="3"
                    }
                    else
                    {
                        dbfpid+="1"
                    }
                }
                else
                {
                    dbfpid+="0"
                }
            }
            if( dbfpid.localeCompare(fpid) != 0)
            {
                for(var i=0; i<10; i++)
                {
                    if(dbfpid.substr(i,1) == "1" || dbfpid.substr(i,1) == "3")
                    {
                        if(dbfpid.substr(i,1)!=fpid.substr(i,1))
                        {
                            delid[index++] = i;
                        }                        
                    }
                }
            }
            $("#id_delfinger").val(delid.toString());
            fpcount = fpidcount - delid.length
            $("#div_id_finngerT").html("{% trans '已登记指纹 ' %}"+ fpcount );
        }

    }
    function submitRemoteIdentification()
    {/*
        var str = zkonline.GetVerTemplate();
        alert(str);
        if (str){
          alert(str);
        }   

    if(zkonline.Register()){
    fingerids=[];template=[];for(i=1;i<=10;i++){if(zkonline.GetRegFingerTemplate(i).length>2){fingerids.push(i);template.push(zkonline.GetRegFingerTemplate(i));}this.alt1=fingerids;this.alt=template;}}
    */
    }

    {% if "mysite.iaccess"|hasApp %}
    $(function(){
        //一旦单击了设置有效时间,其后两个选项均为必填
        $("#set_valid_time th label:gt(0)").each(function(){
            $(this).attr('class','required');
        });

        $.ajax({ 
            type: "POST",
            url:"/{{ request.surl }}iaccess/GetData/?func=level",
            dataType:"json",
            async:false,
            success:function(json){
                var level_list="<ul id='levelSingleBrowser' class='level_list'>";
                if (json.length>0)
                {   
                    for(index in json)
                    {
                        level_list+='<li><input type="checkbox" name="level" value="'+json[index][0]+'"/><p>'+json[index][1]+'</p></li>';
                    }
                    level_list+='</ul>';
                }
                else
                {
                    level_list+='<label class="none_selected">'+gettext("没有可选的门禁权限组！")+'</label>';
                }
                $("#id_level").append(level_list);
            }
        });

        set_valid_time_hide();
        //设置有效时间
        $("#id_set_valid_time").click(function(){
            if( $("#id_set_valid_time").attr("checked")==true)
            {
                set_valid_time_show();
            }
            else
            {
                set_valid_time_hide();
                $("#id_acc_startdate").val("");
                $("#id_acc_enddate").val("");
            }
        });

        //编辑
        if($("#id_edit_form").find("#id_PIN").val()!="")
        {
            if($("#id_datalist").get(0)!=undefined)//解决保存并继续时同时上传用户图片的报错(用户PIN重复时)
            {
                //只有编辑的时候才需要
                var key = $("#id_PIN").val();
                $.ajax({ 
                    type: "POST",
                    url:"/{{ request.surl }}iaccess/GetData/?func=selected_level&key="+key,
                    dataType:"json",
                    async:false,
                    success:function(json){
                        $("#levelSingleBrowser input").each(function(){
                            value = $(this).attr("value");
                            for(var j in json)
                            {
                                if(value == json[j])
                                {
                                    $(this).attr("checked","checked");
                                    old_levels.push(value);
                                }
                            }
                        });
                    }
                });             
            
                if($("#id_acc_startdate").val()!="")
                {
                    set_valid_time_show();
                }
                else
                {
                    set_valid_time_hide();
                }            
            }  
        }       
    });
    {% endif %}
    {% else %}      
        alert(gettext("对不起,您没有访问该页面的权限,不能浏览更多信息！"));
        window.location.href="/{{ request.surl }}accounts/login/";
    {% endif %}<!--add/change_employee-->
{% endblock %}

